<%= render 'shared/header' %>

<div class="container mx-auto px-4 my-8">
  <% flash.each do |type, message| %>
    <% bg_color = case type.to_sym
      when :notice then "bg-green-100 text-green-800 border-green-300"
      when :alert  then "bg-red-100 text-red-800 border-red-300"
      else "bg-gray-100 text-gray-800 border-gray-300"
    end %>
    <div class="border-l-4 p-4 mb-4 <%= bg_color %>"><p><%= message %></p></div>
  <% end %>

  <h1 class="text-2xl font-bold mb-4">マイページ</h1>
  <p>メールアドレス: <%= @user.email %></p>

  <% if @mysauna.present? %>
    <div class="mt-6 p-4 border rounded bg-gray-100">
      <h2 class="text-xl font-semibold mb-2">Mysauna</h2>

      <% if @mysauna.image.attached? %>
        <%= image_tag @mysauna.image.variant(resize_to_limit: [300, 300]), class: "rounded shadow mb-4 block max-w-full" %>
      <% else %>
        <p>画像はまだ登録されていません</p>
      <% end %>

      <p><strong>施設名:</strong> <%= @mysauna.sauna_name %></p>
      <p><strong>コメント:</strong> <%= @mysauna.comment %></p>
      <div class="mt-6 flex flex-wrap items-center justify-start space-x-4">
        <!-- ボタン① -->
        <%= link_to "編集する", edit_mysauna_path(@mysauna),
          class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm sm:text-base inline-block" %>

        <!-- ボタン② -->
        <%= tag.form method: :post, action: posts_path, class: "inline-block" do %>
          <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
          <%= submit_tag "投稿",
            class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm sm:text-base" %>
        <% end %>

        <!-- ボタン③ -->
        <%= link_to "Xでシェア", share_mysauna_url(@mysauna),
          class: "bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded text-sm sm:text-base inline-block",
          target: "_blank", rel: "noopener" %>
      </div>
    </div>
  <% else %>
    <p class="mt-4">まだMysaunaは登録されていません。</p>
    <%= link_to "Mysaunaを登録する", new_mysauna_path, class: "bg-blue-500 text-white py-2 px-4 rounded mt-2 inline-block" %>
  <% end %>
  <% if @user.diagnoses.exists? %>
    <div class="mt-10">
      <h2 class="text-xl font-semibold mb-4">診断履歴</h2>
      <% @user.diagnoses.order(created_at: :desc).each do |diagnosis| %>
        <% if diagnosis.diagnosis_recommendations.any? %>
          <div class="border rounded p-3 mb-2 bg-white shadow">
            <p class="text-sm text-gray-600 mb-1"><%= l diagnosis.created_at, format: :short %> に診断</p>
            <% diagnosis.diagnosis_recommendations.each do |rec| %>
              <div class="flex items-center justify-between">
                <%= link_to rec.sauna_facility.name, sauna_facility_path(rec.sauna_facility), class: "text-blue-600 underline" %>
                <% if current_user.favorite_sauna_facilities.include?(rec.sauna_facility) %>
                  <%= button_to "♡", delete_favorite_path(sauna_facility_id: rec.sauna_facility.id),
                    method: :delete,
                    class: "text-red-500",
                    form: { data: { turbo: false } } %>
                <% else %>
                  <%= button_to "♡", favorites_path(sauna_facility_id: rec.sauna_facility.id),
                    method: :post,
                    class: "text-gray-400",
                    form: { data: { turbo: false } } %>
                <% end %>
              </div>
            <% end %>
          </div>
        <% end %>
      <% end %>
    </div>
  <% end %>
  <!-- ✅ お気に入り一覧・マップ追加ブロックここから -->
  <% if current_user.favorite_sauna_facilities.exists? %>
    <div class="mt-10">
      <h2 class="text-xl font-semibold mb-4">お気に入りサウナ一覧</h2>

      <ul class="list-disc pl-6 space-y-2 mb-6">
        <% current_user.favorite_sauna_facilities.each do |facility| %>
          <li>
            <%= link_to facility.name, sauna_facility_path(facility), class: "text-blue-600 underline" %>
            <span class="text-gray-500 text-sm">（<%= facility.location %>）</span>
          </li>
        <% end %>
      </ul>

      <h2 class="text-xl font-semibold mb-4">お気に入りサウナMAP</h2>
      <div id="favorite-map" style="height: 400px;" class="rounded shadow border border-gray-300"></div>
    </div>

    <script>
      function initFavoriteMap() {
        const map = new google.maps.Map(document.getElementById("favorite-map"), {
          zoom: 10,
          center: { lat: 35.68, lng: 139.76 }, // 東京中心（デフォルト）
        });

        const facilities = <%= raw(current_user.favorite_sauna_facilities.to_json(only: [:name, :latitude, :longitude])) %>;
        facilities.forEach(facility => {
          const marker = new google.maps.Marker({
            position: { lat: facility.latitude, lng: facility.longitude },
            map: map,
            title: facility.name
          });

          const info = new google.maps.InfoWindow({
            content: `<strong>${facility.name}</strong>`
          });

          marker.addListener("click", () => {
            info.open(map, marker);
          });
        });
      }
    </script>
    <script async defer src="https://maps.googleapis.com/maps/api/js?key=<%= ENV["GOOGLE_MAPS_API_KEY"] %>&callback=initFavoriteMap"></script>
  <% end %>
  <!-- ✅ お気に入りマップ追加ブロックここまで -->

</div>

<%= render 'shared/footer' %>